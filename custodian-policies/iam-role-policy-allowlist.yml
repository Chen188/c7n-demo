vars:
  allowed-policy-arn: &allowed-policy-arn
    - "arn:aws:iam::{account_id}:policy/custodian-cicd"
    - "arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess"
    - "arn:aws:iam::aws:policy/AmazonVPCReadOnlyAccess"
    - "arn:aws:iam::aws:policy/service-role/AWSConfigRulesExecutionRole"
    - "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"

policies:
  - name: whitelist-custodian-cicd-iam-polices
    description: whitelist policies attached to iam role custodian-cicd-role
    resource: aws.iam-role
    mode:
      type: config-rule
      role: arn:aws:iam::{account_id}:role/custodian-lambda-exec-role
    # mode:
    #   type: periodic
    #   schedule: "rate(1 hour)"
    #   role: arn:aws:iam::{account_id}:role/custodian-lambda-exec-role
    filters:
      - RoleName: custodian-cicd-role
      - type: has-specific-managed-policy
        op: not-in
        key: PolicyArn
        value: *allowed-policy-arn
    actions:
      - type: set-policy
        state: detached
        arn: "*"
      - type: set-policy
        state: attached
        arn: "arn:aws:iam::{account_id}:policy/custodian-cicd"
      - type: set-policy
        state: attached
        arn: "arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess"
      - type: set-policy
        state: attached
        arn: "arn:aws:iam::aws:policy/AmazonVPCReadOnlyAccess"
      - type: set-policy
        state: attached
        arn: "arn:aws:iam::aws:policy/service-role/AWSConfigRulesExecutionRole"
      - type: set-policy
        state: attached
        arn: "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"